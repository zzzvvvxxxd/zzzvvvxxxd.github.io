<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="zzzvvvxxxd" type="application/atom+xml" />






<meta property="og:type" content="website">
<meta property="og:title" content="zzzvvvxxxd">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="zzzvvvxxxd">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="zzzvvvxxxd">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>zzzvvvxxxd</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zzzvvvxxxd</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">最快的外卖小哥</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/04/02/atomic3-getAndIncrement/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zzzvvvxxxd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zzzvvvxxxd">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/02/atomic3-getAndIncrement/" itemprop="url">【不简单的Atomic工具】getAndAddInt in getAndIncrement</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-04-02T11:44:53+08:00">
                2016-04-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/atomic/" itemprop="url" rel="index">
                    <span itemprop="name">atomic</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/04/02/atomic3-getAndIncrement/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/04/02/atomic3-getAndIncrement/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇Atmoic文章中提到，JDK8在<code>AtomicInteger</code>的<code>getAndIncrement</code>方法实现上发生了变化：  </p>
<h5 id="JDK7"><a href="#JDK7" class="headerlink" title="JDK7"></a>JDK7</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">for</span> (;;) &#123;</div><div class="line">    <span class="keyword">int</span> current = get();</div><div class="line">    <span class="keyword">int</span> next = current + <span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span> (compareAndSet(current, next))</div><div class="line">      <span class="keyword">return</span> current;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="JDK8"><a href="#JDK8" class="headerlink" title="JDK8"></a>JDK8</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, <span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>getAndAddInt</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndAddInt</span><span class="params">(Object paramObject, <span class="keyword">long</span> paramLong, <span class="keyword">int</span> paramInt)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">do</span></div><div class="line">      i = getIntVolatile(paramObject, paramLong);</div><div class="line">    <span class="keyword">while</span> (!(compareAndSwapInt(paramObject, paramLong, i, i + paramInt)));</div><div class="line">    <span class="keyword">return</span> i;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">jint</div><div class="line">sun::misc::Unsafe::getIntVolatile (jobject obj, jlong offset)</div><div class="line">&#123;</div><div class="line">  volatile jint *addr = (jint *) ((char *) obj + offset);</div><div class="line">  jint result = *addr;</div><div class="line">  read_barrier ();</div><div class="line">  return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="汇编之后"><a href="#汇编之后" class="headerlink" title="汇编之后"></a>汇编之后</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">0x0000000002c207f5: lock cmpxchg %r8d,0xc(%rdx)</div><div class="line">0x0000000002c207fb: sete   %r11b</div><div class="line">0x0000000002c207ff: movzbl %r11b,%r11d</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">0x0000000002cf49c7: mov    %rbp,0x10(%rsp)</div><div class="line">0x0000000002cf49cc: mov    $0x1,%eax</div><div class="line">0x0000000002cf49d1: lock xadd %eax,0xc(%rdx)</div></pre></td></tr></table></figure>
<p>原本的<code>lock cmpxchg</code>被<code>lock xadd</code>所替换，也就是在1.8之后，在硬件支持<code>lock XADD</code>这样的操作情况下，都会用fetch-and-add来替换CAS操作。</p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><ul>
<li><a href="http://javagoo.tk/java/unsafe_getAndAddInt.html?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">unsafe中getAndAddInt性能疑问</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/27/atomic2-CAS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zzzvvvxxxd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zzzvvvxxxd">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/27/atomic2-CAS/" itemprop="url">【不简单的Atomic工具】CAS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-03-27T21:12:33+08:00">
                2016-03-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/atomic/" itemprop="url" rel="index">
                    <span itemprop="name">atomic</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/03/27/atomic2-CAS/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/03/27/atomic2-CAS/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="CAS算法："><a href="#CAS算法：" class="headerlink" title="CAS算法："></a>CAS算法：</h2><p>包含三个参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CAS(V, E, N)</div></pre></td></tr></table></figure></p>
<ul>
<li>V 表示要更新的变量</li>
<li>E 表示预期值</li>
<li>N 表示新值</li>
</ul>
<p>仅当V值等于E值时，才会将V的值设置为N。如果V的值和E不同，表示已经有其他线程对其进行了更新，则当前线程什么都不做。最后CAS返回V的真实值。</p>
<p>CAS是抱着乐观的态度进行的，总认为自己可以成功的完成操作。当多个线程同时使用CAS操作一个变量时，只有一个会胜出。失败的线程不会被挂起，而是返回失败信息，并允许再次尝试。</p>
<p>CPU指令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cmpxchg</div><div class="line"># accumulator = AL, AX, or EAX, depending on whether a byte, word, or doubleword comparison is being performed</div></pre></td></tr></table></figure></p>
<p>该指令的基本逻辑如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(accumulator == Destination) &#123;</div><div class="line">    ZF = <span class="number">1</span>;</div><div class="line">    Destination = Source;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    ZF = <span class="number">0</span>;</div><div class="line">    accumulator = Destination;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h2><ol>
<li><p>ABA问题。</p>
<blockquote>
<p>因为 CAS 需要在操作值的时候检查下值有没有发生变化，如果没有发生变化则更新，但是如果一个值原来是A，变成了B，又变成了A，那么使用CAS进行检查时会发现它的值没有发生变化，但是实际上却变化了。ABA问题的解决思路就是使用版本号。在变量前面追加上版本号，每次变量更新的时候把版本号加一，那么A－B－A 就会变成1A-2B－3A。<br>从Java1.5开始JDK的atomic包里提供了一个类 AtomicStampedReference 来解决 ABA 问题。这个类的compareAndSet 方法作用是首先检查当前引用是否等于预期引用，并且当前标志是否等于预期标志，如果全部相等，则以原子方式将该引用和该标志的值设置为给定的更新值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span></span></div><div class="line">        <span class="params">(V      expectedReference,//预期引用</span></div><div class="line">         V      newReference,//更新后的引用</div><div class="line">        <span class="keyword">int</span>    expectedStamp, //预期标志</div><div class="line">        <span class="keyword">int</span>    newStamp) <span class="comment">//更新后的标志</span></div></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>循环时间长开销大。</p>
<blockquote>
<p>自旋 CAS 如果长时间不成功，会给 CPU 带来非常大的执行开销。如果JVM能支持处理器提供的 pause 指令那么效率会有一定的提升，pause 指令有两个作用，第一它可以延迟流水线执行指令（de-pipeline）,使 CPU 不会消耗过多的执行资源，延迟的时间取决于具体实现的版本，在一些处理器上延迟时间是零。第二它可以避免在退出循环的时候因内存顺序冲突（memory order violation：内存顺序冲突一般是由伪/假共享引起，假共享是指多个 CPU 同时修改同一个缓存行的不同部分而引起其中一个CPU的操作无效，当出现这个内存顺序冲突时，CPU必须清空流水线）而引起 CPU 流水线被清空（CPU pipeline flush），从而提高 CPU 的执行效率。</p>
</blockquote>
</li>
<li><p>只能保证一个共享变量的原子操作。</p>
<blockquote>
<p>当对一个共享变量执行操作时，我们可以使用循环CAS的方式来保证原子操作，但是对多个共享变量操作时，循环CAS就无法保证操作的原子性，这个时候就可以用锁，或者有一个取巧的办法，就是把多个共享变量合并成一个共享变量来操作。比如有两个共享变量i＝2,j=a，合并一下ij=2a，然后用CAS来操作ij。从Java1.5开始JDK提供了AtomicReference类来保证引用对象之间的原子性，你可以把多个变量放在一个对象里来进行CAS操作。</p>
</blockquote>
</li>
</ol>
<h2 id="AtmoicInteger中的CAS实现"><a href="#AtmoicInteger中的CAS实现" class="headerlink" title="AtmoicInteger中的CAS实现"></a>AtmoicInteger中的CAS实现</h2><p><strong>JDK7</strong>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">for</span> (;;) &#123;</div><div class="line">    <span class="keyword">int</span> current = get();</div><div class="line">    <span class="keyword">int</span> next = current + <span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span> (compareAndSet(current, next))</div><div class="line">      <span class="keyword">return</span> current;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>JDK8</strong>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, <span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到JDK8在<code>getAndIncrement()</code>方法的实现上做出了一定的改变，在<a href="http://ashkrit.blogspot.com/2014/02/atomicinteger-java-7-vs-java-8.html" target="_blank" rel="external">AtomicInteger Java 7 vs Java 8</a>中列出了两个版本的benchmark，JDK8的实现大约提升了1.5~2倍的性能，作者也直呼<code>Unsafe</code>变得更加与有用了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/26/算法-两个栈组成的队列/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zzzvvvxxxd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zzzvvvxxxd">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/26/算法-两个栈组成的队列/" itemprop="url">两个栈组成队列</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-03-26T19:12:06+08:00">
                2016-03-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/算法/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/03/26/算法-两个栈组成的队列/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/03/26/算法-两个栈组成的队列/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="【题目】"><a href="#【题目】" class="headerlink" title="【题目】"></a>【题目】</h2><p>编写一个类，用两个栈实现队列的基本操作：add、poll、peek  </p>
<h2 id="【解法】"><a href="#【解法】" class="headerlink" title="【解法】"></a>【解法】</h2><p>一个栈作为压入栈，在压入数据时只往这个栈中压入，记为stackPush。另一个栈只作为单出栈，在弹出数据时只从这个栈弹出，记为stackPop。<br>stackPop会将stackPush中的数据整体弹出再压入stackPop作为弹出顺序。<br>需要做到以下两点：  </p>
<ol>
<li>如果stackPush要往stackPop中压入数据，那么必须一次性把stackPush中的数据全部压入  </li>
<li>如果stackPop不为空，stackPush绝对不能向stackPop中压入数据  </li>
</ol>
<h2 id="【代码】"><a href="#【代码】" class="headerlink" title="【代码】"></a>【代码】</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TwoStackQueue</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> Stack&lt;Integer&gt; stackPush;</div><div class="line">    <span class="keyword">public</span> Stack&lt;Integer&gt; stackPop;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TwoStackQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">        stackPush = <span class="keyword">new</span> Stack&lt;Integer&gt;();</div><div class="line">        stackPop = <span class="keyword">new</span> Stack&lt;Integer&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> pushInt)</span> </span>&#123;</div><div class="line">        stackPush.push(pushInt);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">poll</span><span class="params">()</span> </span>&#123;</div><div class="line">        putPushToPop();</div><div class="line">        <span class="keyword">return</span> stackPop.pop();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">peek</span><span class="params">()</span> </span>&#123;</div><div class="line">        putPushToPop();</div><div class="line">        <span class="keyword">return</span> stackPop.peek();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putPushToPop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(stackPop.empty() &amp;&amp; stackPush.empty()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Queue is empty"</span>);</div><div class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(stackPop.empty()) &#123;</div><div class="line">            stackPush.stream().forEach(item -&gt; &#123;</div><div class="line">                stackPop.push(item);</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/26/one2oneQueue1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zzzvvvxxxd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zzzvvvxxxd">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/26/one2oneQueue1/" itemprop="url">OneToOneQueue —— 终极性能的无锁队列算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-03-26T16:37:41+08:00">
                2016-03-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/多线程/" itemprop="url" rel="index">
                    <span itemprop="name">多线程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/03/26/one2oneQueue1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/03/26/one2oneQueue1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基本的队列设计"><a href="#基本的队列设计" class="headerlink" title="基本的队列设计"></a>基本的队列设计</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToOneConcurrentArrayQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Queue</span>&lt;<span class="title">E</span>&gt;</span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> E[] buffer;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> tail = <span class="number">0</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> head = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">OneToOneConcurrentArrayQueue</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</div><div class="line">	    buffer = (E[])<span class="keyword">new</span> Object[capacity];</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">	    <span class="keyword">final</span> <span class="keyword">long</span> currentTail = tail;</div><div class="line">	    <span class="keyword">final</span> <span class="keyword">long</span> wrapPoint = currentTail - buffer.length;  <span class="comment">// tail位置往前移动length个位置</span></div><div class="line">	    <span class="keyword">if</span>(head &lt;= wrapPoint) &#123;</div><div class="line">	        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	    &#125;</div><div class="line">	    buffer[(<span class="keyword">int</span>)(currentTail % buffer.length)] = e;</div><div class="line">	    tail = currentTail + <span class="number">1</span>;</div><div class="line">	    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</div><div class="line">	    <span class="keyword">final</span> <span class="keyword">long</span> currentHead = head;</div><div class="line">	    <span class="keyword">if</span>(currentHead &gt;= tail) &#123;</div><div class="line">	        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	    &#125;</div><div class="line">	    <span class="keyword">final</span> <span class="keyword">int</span> index = (<span class="keyword">int</span>)(currentHead % buffer.length);</div><div class="line">	    <span class="keyword">final</span> E e = buffer[index];</div><div class="line">	    buffer[index] = <span class="keyword">null</span>;</div><div class="line">	    head = currentHead + <span class="number">1</span>;</div><div class="line">	    <span class="keyword">return</span> e;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样的队列性能损耗主要是一下两点：  </p>
<ol>
<li>取余的计算  </li>
<li>volatile write以及该过程中可能发生的false sharing<br>因为我们探讨的OneToOne队列，那么显然volatile的刷新要求并不是很严格，可以不用每次的写操作都从cache中刷回主存  </li>
</ol>
<hr>
<h1 id="改进-1"><a href="#改进-1" class="headerlink" title="改进 - 1"></a>改进 - 1</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToOneConcurrentArrayQueue2</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">    <span class="keyword">implements</span> <span class="title">Queue</span>&lt;<span class="title">E</span>&gt;</div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mask;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> E[] buffer;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong tail = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong head = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">OneToOneConcurrentArrayQueue2</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</div><div class="line">		<span class="comment">// 确保capacity是2^n</span></div><div class="line">        capacity = findNextPositivePowerOfTwo(capacity);</div><div class="line">        mask = capacity - <span class="number">1</span>;</div><div class="line">        buffer = (E[])<span class="keyword">new</span> Object[capacity];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(<span class="keyword">final</span> E e)</span></span></div><div class="line">	&#123;</div><div class="line">	    <span class="keyword">final</span> <span class="keyword">long</span> currentTail = tail.get();</div><div class="line">	    <span class="keyword">final</span> <span class="keyword">long</span> wrapPoint = currentTail - buffer.length;</div><div class="line">	    <span class="keyword">if</span> (head.get() &lt;= wrapPoint) &#123;</div><div class="line">	        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	    &#125;</div><div class="line">	    <span class="comment">// 替换了： buffer[(int)(currentTail % buffer.length)] = e;</span></div><div class="line">	    <span class="comment">// 优化了&amp;操作</span></div><div class="line">		buffer[(<span class="keyword">int</span>)currentTail &amp; mask] = e; </div><div class="line">		tail.lazySet(currentTail + <span class="number">1</span>);</div><div class="line">	    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">	    <span class="keyword">final</span> <span class="keyword">long</span> currentHead = head.get();</div><div class="line">	    <span class="keyword">if</span> (currentHead &gt;= tail.get())</div><div class="line">	    &#123;</div><div class="line">	        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	    &#125;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> index = (<span class="keyword">int</span>)currentHead &amp; mask; </div><div class="line">		<span class="keyword">final</span> E e = buffer[index];</div><div class="line">		buffer[index] = <span class="keyword">null</span>; </div><div class="line">		head.lazySet(currentHead + <span class="number">1</span>);</div><div class="line">		<span class="keyword">return</span> e; </div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="优化点1"><a href="#优化点1" class="headerlink" title="优化点1"></a>优化点1</h3><p>注意这里使用<code>(int)currentTail &amp; (capacity - 1)</code>优化了<code>buffer[(int)(currentTail % capacity)] = e;</code>的取余操作。<br>不过这样的优化存在一个问题就是capacity必须是2^n   </p>
<h3 id="优化点2"><a href="#优化点2" class="headerlink" title="优化点2"></a>优化点2</h3><p>head和tail用AtomicLong替代long<br>使用了lazySet来避免了频繁的volatile write在维持内存可见性时的内存损耗  </p>
<hr>
<h1 id="改进-2"><a href="#改进-2" class="headerlink" title="改进 - 2"></a>改进 - 2</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToOneConcurrentArrayQueue3</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Queue</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> capacity; </div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mask; </div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> E[] buffer;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicLong tail = <span class="keyword">new</span> PaddedAtomicLong(<span class="number">0</span>); </div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicLong head = <span class="keyword">new</span> PaddedAtomicLong(<span class="number">0</span>);</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PaddedLong</span> </span>&#123;</div><div class="line">		<span class="keyword">public</span> <span class="keyword">long</span> value = <span class="number">0</span>, p1, p2, p3, p4, p5, p6; </div><div class="line">	&#125;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> PaddedLong tailCache = <span class="keyword">new</span> PaddedLong(); </div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> PaddedLong headCache = <span class="keyword">new</span> PaddedLong();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(<span class="keyword">final</span> E e)</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">long</span> currentTail = tail.get();</div><div class="line">		<span class="keyword">final</span> <span class="keyword">long</span> wrapPoint = currentTail - capacity; </div><div class="line">		<span class="keyword">if</span> (headCache.value &lt;= wrapPoint) &#123;</div><div class="line">			headCache.value = head.get();</div><div class="line">			<span class="keyword">if</span> (headCache.value &lt;= wrapPoint) &#123;</div><div class="line">				<span class="keyword">return</span> <span class="keyword">false</span>; </div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		buffer[(<span class="keyword">int</span>)currentTail &amp; mask] = e;</div><div class="line">		tail.lazySet(currentTail + <span class="number">1</span>); </div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">long</span> currentHead = head.get(); </div><div class="line">		<span class="keyword">if</span> (currentHead &gt;= tailCache.value) &#123;</div><div class="line">			tailCache.value = tail.get();</div><div class="line">			<span class="keyword">if</span> (currentHead &gt;= tailCache.value) &#123;</div><div class="line">		        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		    &#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">int</span> index = (<span class="keyword">int</span>)currentHead &amp; mask; </div><div class="line">		<span class="keyword">final</span> E e = buffer[index];</div><div class="line">		buffer[index] = <span class="keyword">null</span>; </div><div class="line">		head.lazySet(currentHead + <span class="number">1</span>);</div><div class="line">		<span class="keyword">return</span> e; </div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="优化点："><a href="#优化点：" class="headerlink" title="优化点："></a>优化点：</h3><p>使用tailCache和headCache来避免对head和tail两个AtomicLong的频繁get()，读取普通变量肯定会比Atomic快很多  </p>
<h1 id="实验结果"><a href="#实验结果" class="headerlink" title="实验结果"></a>实验结果</h1><p>贴上参考文章中的实验结果：  </p>
<table>
<thead>
<tr>
<th></th>
<th>Qps/Sec(Millions)</th>
<th>Mean Latency(ns)</th>
</tr>
</thead>
<tbody>
<tr>
<td>LinkedBlockingQueue</td>
<td>4.3</td>
<td>~32000 / ~500</td>
</tr>
<tr>
<td>ArrayBlockingQueue</td>
<td>3.5</td>
<td>~32000 / ~600</td>
</tr>
<tr>
<td>ConcurrentLinkedQueue</td>
<td>13</td>
<td>NA / ~180</td>
</tr>
<tr>
<td>ConcurrentArrayQueue</td>
<td>13</td>
<td>NA / ~150</td>
</tr>
<tr>
<td>ConcurrentArrayQueue2</td>
<td>45</td>
<td>NA / ~120</td>
</tr>
<tr>
<td>ConcurrentArrayQueue3</td>
<td>150</td>
<td>NA / ~100</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Note: None of these tests are run with thread affinity set, Sandy Bridge 2.4 GHz Latency: Blocking - put() &amp; take() / Non-Blocking - offer() &amp; poll()</p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://www.infoq.com/presentations/Lock-Free-Algorithms" target="_blank" rel="external">1. 终极性能的无锁队列算法</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/26/false_sharing2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zzzvvvxxxd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zzzvvvxxxd">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/26/false_sharing2/" itemprop="url">False Sharing问题（2）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-03-26T16:32:38+08:00">
                2016-03-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/多线程/" itemprop="url" rel="index">
                    <span itemprop="name">多线程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/03/26/false_sharing2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/03/26/false_sharing2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="如果避免频繁的false-sharing造成的性能损耗："><a href="#如果避免频繁的false-sharing造成的性能损耗：" class="headerlink" title="如果避免频繁的false sharing造成的性能损耗："></a>如果避免频繁的false sharing造成的性能损耗：</h2><p><strong>PaddedLong</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PaddedLong</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">long</span> value = <span class="number">0</span>, p1, p2, p3, p4, p5, p6; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>PaddedAtomicLong</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaddedAtomicLong</span> <span class="keyword">extends</span> <span class="title">AtomicLong</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PaddedAtomicLong</span><span class="params">()</span> </span>&#123;</div><div class="line">    	<span class="keyword">super</span>();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PaddedAtomicLong</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> initialValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(initialValue);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">long</span> p1, p2, p3, p4, p5, p6 = <span class="number">7</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="为何是插入7个long"><a href="#为何是插入7个long" class="headerlink" title="为何是插入7个long"></a>为何是插入7个long</h2><p>一般而言cache line是64byte，而每个Java对象都有一个2word（2*4byte）的对象头，而long本身是8byte。  </p>
<h2 id="PaddedLong的应用"><a href="#PaddedLong的应用" class="headerlink" title="PaddedLong的应用"></a>PaddedLong的应用</h2><p>一般是用在频繁读写的情况下，可以参考之后的OneToOne队列的优化文章</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/25/false_sharing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zzzvvvxxxd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zzzvvvxxxd">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/25/false_sharing/" itemprop="url">False Sharing问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-03-25T14:37:11+08:00">
                2016-03-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/多线程/" itemprop="url" rel="index">
                    <span itemprop="name">多线程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/03/25/false_sharing/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/03/25/false_sharing/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><h3 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h3><p>对着多核的发展，CPU cache分成了三个级别：L1、L2、L3。L1是最接近CPU的cache，容量也是最小的，但是速度最快。  </p>
<table>
<thead>
<tr>
<th>从CPU到</th>
<th>大约需要的CPU周期</th>
<th>大约需要的时间（单位ns）</th>
</tr>
</thead>
<tbody>
<tr>
<td>寄存器</td>
<td>1 cycle</td>
<td>NA</td>
</tr>
<tr>
<td>L1 Cache</td>
<td>约3~4 cycles</td>
<td>约0.5~1ns</td>
</tr>
<tr>
<td>L2 Cache</td>
<td>约10~20 cycles</td>
<td>约3~7ns</td>
</tr>
<tr>
<td>L3 Cache</td>
<td>约40~45 cycles</td>
<td>约15ns</td>
</tr>
<tr>
<td>跨槽传输</td>
<td>空</td>
<td>约20ns</td>
</tr>
<tr>
<td>内存</td>
<td>约120~240 cycles</td>
<td>约60-120ns</td>
</tr>
</tbody>
</table>
<h3 id="Cache-line"><a href="#Cache-line" class="headerlink" title="Cache line"></a>Cache line</h3><p>为了高效的存取缓存，不是简单地随意地将单条数据写入缓存，缓存是由Cache line构成存储的最小单位，intel平台一般是64字节<br>可以通过命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat /sys/devices/system/cpu/cpu0/cache/index0/coherency_line_size</div></pre></td></tr></table></figure></p>
<p>Java中long占8个字节，再加上对象头（2字节）或者数组对象头（3字节），则可以获取7个long</p>
<h3 id="Cache条目"><a href="#Cache条目" class="headerlink" title="Cache条目"></a>Cache条目</h3><p>cache entry： 包含了如下部分</p>
<ul>
<li>cache line: 从主存一次copy的数据大小</li>
<li>tag：标记cache line对应的主存的地址</li>
<li>falg：标记当前cache是否invalid，如果是数据cache，还有是否dirty</li>
</ul>
<h3 id="CPU的cache策略"><a href="#CPU的cache策略" class="headerlink" title="CPU的cache策略"></a>CPU的cache策略</h3><ol>
<li>cpu从不直接访问主存，通过cache间接访问</li>
<li>每次需要访问主存时，遍历一遍全部cache line，查找主存的地址是否在某个cache line中</li>
<li>如果cache中没有找到，则分配一个新的cache entry，把主存copy到cache line中，再从cache line中读取<br>同时，Cache中包含的cache entry有限，所以必须要有合理cache淘汰策略，一般是LRU，这里不再赘述。</li>
</ol>
<h2 id="False-Sharing"><a href="#False-Sharing" class="headerlink" title="False Sharing"></a>False Sharing</h2><p>在多处理器，多线程的情况下，如果两个线程分别运行在不同CPU上，而其中某个线程修改了cache line中的元素，由于cache一致性原因，另一个线程的cache的line被宣告无效，在下一次访问时会出现一次cache line miss。  </p>
<p>如下图所示，thread1修改了memory灰化区域的第[2]个元素，而Thread0只需要读取灰化区域的第[1]个元素，由于这段memory被载入了各自CPU的硬件cache中，虽然在memory的角度这两种的访问时隔离的，但是由于错误的紧凑地放在了一起，而导致了，thread1的修改，在cache一致性的要求下，宣告了运行Thread0的CPU0的cache line非法，从而出现了一次miss，导致从小从memory中读取到cache line中，而一致性的代价付出了，但结果并不是thread0所care的，导致了效率的降低  </p>
<p><img src="https://software.intel.com/sites/default/files/m/d/4/1/d/8/5-4-figure-1.gif" alt="figure 1"></p>
<blockquote>
<p>在做多线程程序的时候,为了避免使用锁,我们通常会采用这样的数据结构:根据线程的数目,安排一个数组, 每个线程一个项,互相不冲突. 从逻辑上看这样的设计无懈可击,但是实践的过程我们会发现这样并没有提高速度. 问题在于cpu的cache line. 我们在读主存的时候,数据同时被读到L1,L2中去,而且在L1中是以cache line(通常64)字节为单位的. 每个Core都有自己的L1,L2,所以每个线程在读取自己的项的时候, 也把别人的项读进去, 所以在更新的时候,为了保持数据的一致性, core之间cache要进行同步, 这个会导致严重的性能问题. 这就是所谓的False sharing问题。</p>
</blockquote>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>打算分成两篇来写，嘿嘿</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://blog.csdn.net/pennyliang/article/details/5766541" target="_blank" rel="external">False Sharing问题</a><br><a href="http://blog.csdn.net/wdzxl198/article/details/11218765" target="_blank" rel="external">由一道淘宝面试题到False sharing问题</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/24/atomic1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zzzvvvxxxd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zzzvvvxxxd">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/24/atomic1/" itemprop="url">【不简单的Atomic工具】lazySet & set</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-03-24T22:40:11+08:00">
                2016-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/atomic/" itemprop="url" rel="index">
                    <span itemprop="name">atomic</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/03/24/atomic1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/03/24/atomic1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在研究Martin Thompson的演讲<a href="http://www.infoq.com/presentations/Lock-Free-Algorithms" target="_blank" rel="external">终极性能的无锁队列算法</a>时遇到了AtomicLong的lazySet方法，作者用这个方法替代了set。之前在公司设计MulSemaphore类时，我就并没有注意到Atomic类还有这样一个方法。  </p>
<h2 id="lazySet"><a href="#lazySet" class="headerlink" title="lazySet()"></a>lazySet()</h2><p>经常在维护一个非阻塞的数据结构时，内部显然常常会有volatile成员，而对于通信队列这样的对性能要求极端的数据结构，JMM要维持volatile的内存可见性，在对这样的成员写操作时，会有频繁的cache的读写（save和load？）到主内存。这样的时间耗损队形能而言，其实也十分重要。<br>lazySet()可以让一个线程在没有其他线程volatile写或者synchronized动作发生前，本地缓存的写操作不必刷回主内存。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lazySet</span><span class="params">(<span class="keyword">int</span> newValue)</span> </span>&#123;</div><div class="line">    unsafe.putOrderedInt(<span class="keyword">this</span>, valueOffset, newValue);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>lazySet的本质就是putOrderInt()，该函数是putIntVolatile()方法的延迟实现。  </p>
<p>正是因为这样的特性，使得lazySet适合于SPSC的数据结构中，对于单Producer单Consumer这样的结构，延迟写并不是什么问题。同时还优化了store-load屏障在性能上的损耗（store-store屏障替代）。 </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/13/mysql_binlog/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zzzvvvxxxd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zzzvvvxxxd">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/02/13/mysql_binlog/" itemprop="url">【mysql】binlog详解(1)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-02-13T16:11:22+08:00">
                2016-02-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/02/13/mysql_binlog/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/02/13/mysql_binlog/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>The binary log contains “events” that describe database changes such as table creation operations or changes to table data. It also contains events for statements that potentially could have made changes (for example, a DELETE which matched no rows), unless row-based logging is used. The binary log also contains information about how long each statement took that updated data.</p>
</blockquote>
<p>binlog是mysql的二进制日志，记录了mysql数据的更新或者潜在的更新记录，同时还包含了每条语句的执行耗时和更新时间。<br>注意： binlog主要有<code>statement-based</code>、<code>row-based logging</code>和<code>mixed logging</code> 三种格式，row-based的记录中不包括潜在更新记录。</p>
<p>binlog有两个主要的功能：</p>
<ul>
<li><p>用于复制</p>
<blockquote>
<p>master发送了包含了所有events的binary log给slaves，slaves执行binary log中的event来保证和master之间的数据一致性</p>
</blockquote>
</li>
<li><p>一些特定的数据恢复操作，会使用binlog</p>
</li>
</ul>
<h2 id="1-binlog相关的启动参数"><a href="#1-binlog相关的启动参数" class="headerlink" title="1. binlog相关的启动参数"></a>1. binlog相关的启动参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--binlog-row-event-max-size=N</div></pre></td></tr></table></figure>
<p>指定行格式复制日志event的最大大小，单位为byte，每一行数据会被切分到多个小于该限制的event包中，必须是256byte的倍数。  </p>
<ul>
<li>默认值：8192</li>
<li>min：256</li>
<li>max：18446744073709551615（64位平台）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--log-bin[=base_name]</div></pre></td></tr></table></figure>
<p>开启binary log功能（用于复制和备份），指定日志名称的base name，mysql会使用指定的base name作为前缀，连续的数据作为后缀生成一系列的日志文件。默认会使用<code>host_name</code>作为base name。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--log-bin-trust-function-creators[=&#123;0|1&#125;]</div></pre></td></tr></table></figure>
<p>指定mysql如何处理函数及存储过程的创建，取决于用户是否认为自己的存储过程及函数是否安全（确定的或者不修改数据），默认对于不安全的存储过程及函数不会写入binlog。这也就是，在开启binlog的时候，如果不设置该参数，使用自定义函数时会出现错误的原因。</p>
<h2 id="2-Statement-selection-options"><a href="#2-Statement-selection-options" class="headerlink" title="2. Statement selection options"></a>2. Statement selection options</h2><p>下面介绍的选项会影响写入到binary log中的记录语句，因此会控制master发送到slaves中的日志的内容。同样，slaves也有相应的参数，在日志选择哪些命令可以执行。</p>
<h3 id="2-1-binlog-do-db"><a href="#2-1-binlog-do-db" class="headerlink" title="2.1  --binlog-do-db"></a>2.1  <code>--binlog-do-db</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--binlog-do-db=db_name</div></pre></td></tr></table></figure>
<p>这个参数的影响取决是使用<code>statement-based</code>还是<code>row-based logging</code>格式的日志。<br><strong>statement-based logging</strong><br>只有操作默认数据库（USE语句指定）的语句才会被记录。如果要指定多个数据库，需要重复使用该参数。但是跨数据库的操作<br>不会因此被记录，因为这里的检查原则，mysql为了尽可能的简单，只会去检查最近的<code>USE</code>语句指定的数据库是否在该参数指定的数据库中。例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">USE sales;</div><div class="line">UPDATE prices.discounts SET percentage = percentage + 10;</div></pre></td></tr></table></figure></p>
<p>该语句在参数为<code>--binlog-do-db=sales</code>的情况下<strong>会</strong>被记录进binlog的，虽然看起来不太能理解。<br>再举个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">USE prices;</div><div class="line">UPDATE sales.january SET amount=amount+1000;</div></pre></td></tr></table></figure></p>
<p>该语句在参数为<code>--binlog-do-db=sales</code>的情况下是<strong>不会</strong>被记录进binlog的。<br><strong>Row-based logging</strong><br>日志会被严格限定在<code>db_name</code>所指定的数据库上，不再受<code>USE</code>的影响。  </p>
<p>在跨数据的修改操作上，需要举一个具体的例子来加深说明<code>statement-based</code>和<code>row-based logging</code>两者的区别，假设初始参数为<code>binlog-do-db=db1</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">USE db1;</div><div class="line">UPDATE db1.table1 SET col1 = 10, db2.table2 SET col2 = 20;</div></pre></td></tr></table></figure></p>
<p>这条操作<code>statement-based</code>的情况下，对两个表的<code>UPDATE</code>操作都被记录，如果是<code>row-based logging</code>，只有针对table1的操作会被记录。<br>现在假设更换默认数据库为db4<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">USE db4;</div><div class="line">UPDATE db1.table1 SET col1 = 10, db2.table2 SET col2 = 20;</div></pre></td></tr></table></figure></p>
<p><code>statement-based</code>不会记录这条操作，而<code>row-based logging</code>则会记录table1的<code>UPDATE</code>操作日志。</p>
<h3 id="2-2-binlog-ignore"><a href="#2-2-binlog-ignore" class="headerlink" title="2.2  --binlog-ignore"></a>2.2  <code>--binlog-ignore</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--binlog-ignore-db=db_name</div></pre></td></tr></table></figure>
<p>这个参数看起来很好理解，但是要注意的是，<code>CREATE TABLE</code>和<code>ALTER TABLE</code>不会受其影响都一定会被写入log，一般这个参数影响的是<code>UPDATE</code>操作。  </p>
<h3 id="2-3-binlog-format"><a href="#2-3-binlog-format" class="headerlink" title="2.3 --binlog-format"></a>2.3 <code>--binlog-format</code></h3><p>指定binlog使用的格式，可选：statement、row、mixed，具体参考下一篇日志</p>
<blockquote>
<p>更多的配置参数可以参考[1]中的官方说明。  </p>
</blockquote>
<h2 id="相关系统参数和配置"><a href="#相关系统参数和配置" class="headerlink" title="相关系统参数和配置"></a>相关系统参数和配置</h2><h3 id="sync-binlog"><a href="#sync-binlog" class="headerlink" title="sync_binlog"></a><code>sync_binlog</code></h3><p>binlog刷新到磁盘的时机跟sync_binlog参数相关，如果设置为0，则表示MySQL不控制binlog的刷新，由文件系统去控制它缓存的刷新，而如果设置为不为0的值则表示每sync_binlog次事务，MySQL调用文件系统的刷新操作刷新binlog到磁盘中。设为1是最安全的，在系统故障时最多丢失一个事务的更新，但是会对性能有所影响，一般情况下会设置为100或者0，牺牲一定的一致性来获取更好的性能。</p>
<h3 id="expire-logs-days"><a href="#expire-logs-days" class="headerlink" title="expire_logs_days"></a><code>expire_logs_days</code></h3><p>指定binlog保留时间</p>
<h3 id="清理binlog"><a href="#清理binlog" class="headerlink" title="清理binlog"></a>清理binlog</h3><p>要手动清理binlog可以通过指定binlog名字或者指定保留的日期  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">purge master logs to BINLOGNAME;</div><div class="line">purge master logs before DATE;</div></pre></td></tr></table></figure>
<h3 id="查看binlog情况"><a href="#查看binlog情况" class="headerlink" title="查看binlog情况"></a>查看binlog情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">SHOW MASTER LOGS;</div><div class="line"></div><div class="line">+------------------+-----------+</div><div class="line">| mysql-bin.000018 |       515 |</div><div class="line">| mysql-bin.000019 |       504 |</div><div class="line">| mysql-bin.000020 |       107 |</div><div class="line">+------------------+-----------+</div></pre></td></tr></table></figure>
<p>第一列是binlog文件名，第二列是binlog文件大小</p>
<h2 id="binlog和redo-undo-log的区别"><a href="#binlog和redo-undo-log的区别" class="headerlink" title="binlog和redo/undo log的区别"></a>binlog和redo/undo log的区别</h2><p>两者是完全不同的日志，主要有一下2个区别：</p>
<ul>
<li>层次不同。redo/undo log是innodb层维护的，而binlog是mysql server层维护的，跟采用何种引擎没有关系，记录的是所有引擎的更新操作的日志记录。</li>
<li>记录内容不同。redo/undo日志记录的是每个页的修改情况，属于物理日志+逻辑日志结合的方式，目的是保证数据的一致性。binlog记录的都是事务操作内容，格式是二进制的。</li>
</ul>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><ol>
<li><a href="http://dev.mysql.com/doc/refman/5.7/en/replication-options-binary-log.html" target="_blank" rel="external">mysql文档 18.1.6.4 Binary Logging Options and Variables</a></li>
<li><a href="http://dev.mysql.com/doc/refman/5.7/en/binary-log.html" target="_blank" rel="external">mysql文档 6.4.4 The Binary Log</a>  </li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/12/13/3PC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zzzvvvxxxd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zzzvvvxxxd">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/12/13/3PC/" itemprop="url">【一致性协议02】 3PC</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-13T11:23:21+08:00">
                2015-12-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/12/13/3PC/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/12/13/3PC/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>3PC是在2PC的基础上，将第二阶段的提交协议中“提交事务请求”过程一分为二，形成了由<code>CanCommit</code>、<code>PreCommit</code>和<code>do Commit</code>三个阶段组成的事务处理协议。  </p>
<p><img src="https://raw.githubusercontent.com/zzzvvvxxxd/Picture/master/hexo/%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E5%8D%8F%E8%AE%AE.png" alt="">  </p>
<h3 id="阶段1：-CanCommit"><a href="#阶段1：-CanCommit" class="headerlink" title="阶段1： CanCommit"></a>阶段1： CanCommit</h3><ol>
<li>事务询问</li>
<li>各参与者向协调者反馈事务询问的相应</li>
</ol>
<h3 id="阶段2：-PreCommit"><a href="#阶段2：-PreCommit" class="headerlink" title="阶段2： PreCommit"></a>阶段2： PreCommit</h3><p>在阶段2中，协调者会根据参与者的反馈情况来决定是否可以进行事务的PreCommit操作，正常情况下，包含两种可能：</p>
<ul>
<li><strong>执行事务预提交</strong><blockquote>
<p>假如协调者从所有参与者获得的反馈都是YES，就会执行事务的预提交</p>
</blockquote>
</li>
</ul>
<ol>
<li>发送预提交请求</li>
<li>事务预提交</li>
<li>各参与者向协调者反馈事务执行的相应</li>
</ol>
<ul>
<li><strong>中断事务</strong><blockquote>
<p>假如任何一个参与者向协调者反馈了NO响应，或者在等待超时之后，协调者尚无法接收到所有的参与者反馈，就会中断事务</p>
</blockquote>
</li>
</ul>
<ol>
<li>发送中断请求：协调者发送abort请求</li>
<li>中断事务：无论是收到来自协调者的abort请求，或是在等待协调者请求过程中超时，参与者都会中断事务</li>
</ol>
<h3 id="阶段3：-doCommit"><a href="#阶段3：-doCommit" class="headerlink" title="阶段3： doCommit"></a>阶段3： doCommit</h3><p>进行真正的事务提交</p>
<ul>
<li><strong>执行提交</strong></li>
</ul>
<ol>
<li>发送提交请求： 协调者发送doCommit请求</li>
<li>事务提交</li>
<li>反馈事务提交结果</li>
<li>完成事务</li>
</ol>
<ul>
<li><strong>中断事务</strong></li>
</ul>
<ol>
<li>发送中断请求</li>
<li>事务回滚：参与者在接收到abort请求后，会利用在第二个阶段记录的undo信息来执行事务回滚操作，并在回滚之后释放在整个事务执行期间占用的资源。  </li>
<li>反馈事务回滚结果</li>
<li>中断事务</li>
</ol>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>阶段3可能会出现两种故障：</p>
<ul>
<li>协调者出现问题</li>
<li>协调者和参与者之间网络出现问题<br>无论那种情况，最终都会导致参与者无法及时收到来协调者的<code>doCommit</code>或是<code>abort</code>请求，参与者在等待超时后，会放弃此次事务再次进行新的事务提交。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/12/11/2PC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zzzvvvxxxd">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zzzvvvxxxd">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/12/11/2PC/" itemprop="url">【一致性协议01】 2PC</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-11T21:43:21+08:00">
                2015-12-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/12/11/2PC/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/12/11/2PC/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Two-Phase Commit,二阶段提交,作为最基础的一致性协议,保证了分布式系统数据的一致性.目前绝大多数的关系型数据库都是使用2PC来完成分布式事务处理的.<br>利用2PC协议能够非常方便地完成所有数据库事务参与者的协调,统一决定事务的提交或回滚,从而能有效地保证分布式数据一致性.  </p>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>原理简单，实现方便</p>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li><p>同步阻塞</p>
<blockquote>
<p>极大的限制了系统的性能</p>
</blockquote>
</li>
<li><p>单点问题</p>
<blockquote>
<p>协调者在整个二阶段提交过程中，一旦出现故障（尤其是在阶段二），都会导致系统无法正常运行</p>
</blockquote>
</li>
<li><p>脑裂</p>
<blockquote>
<p>也就是数据不一致<br>在阶段二，即执行事务提交的阶段，当协调者向所有参与者发送commit请求之后，发生了局域网络异常或者是协调者在尚未发送完commit请求之前自身崩溃，导致只有部分的参与者接收到了commit请求，这部分参与者就会进行事务的提交，没有收到commit的参与者则无法进行事务的提交。于是，整个分布式系统出现数据不一致的情况。</p>
</blockquote>
</li>
</ul>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程:"></a>流程:</h3><p>阶段1: 提交事务请求(投票阶段):</p>
<ol>
<li><p>事务询问.</p>
<blockquote>
<p>协调者向所有的参与者发送事务内容,询问是否可以执行事务提交操作,并开始等待各参与者的响应.  </p>
</blockquote>
</li>
<li><p>执行事务.</p>
<blockquote>
<p>各参与者节点执行事务操作,并将<code>Undo</code>和<code>Redo</code>信息记入事务日志.</p>
</blockquote>
</li>
<li><p>各参与者向协调者反馈事务询问的响应</p>
<blockquote>
<p>如果参与者成功执行了事务操作,那么就反馈给协调者<code>Yes</code>信息,表示事务可以执行; 如果参与者没有成功执行事务就反馈给协调者<code>No</code>响应,表示事务不可以执行.  </p>
</blockquote>
</li>
</ol>
<p>这个阶段可以看成一种投票阶段,即各个参与者投票表明是否要继续执行接下去的事务提交操作.  </p>
<p>阶段2: 执行事务提交<br>这个阶段,协调者会根据参与者的反馈情况来决定是否最终进行<code>commit</code>.一般,包含两种可能:  </p>
<h6 id="1-执行事务提交"><a href="#1-执行事务提交" class="headerlink" title="#1 执行事务提交:"></a>#1 执行事务提交:</h6><ol>
<li><p>发送提交请求</p>
<blockquote>
<p>假如协调者从所有的参与者获得的反馈都是<code>YES</code>,那么就执行提交操作,协调者向参与者发送<code>commit</code>请求</p>
</blockquote>
</li>
<li><p>事务提交</p>
<blockquote>
<p>参与者接受到<code>Commit</code>请求后,会正式执行事务提交操作,并在完成后释放整个事务执行期间所占用的资源</p>
</blockquote>
</li>
<li><p>反馈事务提交结果</p>
<blockquote>
<p>参与者在完成事务提交之后,向协调者发送<code>Ack</code>信息</p>
</blockquote>
</li>
<li><p>完成事务</p>
<blockquote>
<p>协调者收到所有参与者的<code>Ack</code>消息后,完成事务</p>
</blockquote>
</li>
</ol>
<h6 id="2-中断事务"><a href="#2-中断事务" class="headerlink" title="#2 中断事务:"></a>#2 中断事务:</h6><p>如果任何一个参与者返回了<code>No</code>信息，或者等待超时之后，协调者尚无法接受到所有的参与者反馈信息，就会中断事务。  </p>
<ol>
<li><p>发送回滚请求</p>
<blockquote>
<p>协调者向所有参与者发出Rollback请求</p>
</blockquote>
</li>
<li><p>事务回滚</p>
<blockquote>
<p>参与者接收到Rollback请求后，会利用其在阶段一种记录的Undo信息来执行回滚操作，并在完成回滚之后释放在整个事务执行期间占用的资源。  </p>
</blockquote>
</li>
<li><p>反馈事务回滚结果</p>
<blockquote>
<p>参与者在完成事务回滚之后，向协调者发送<code>Ack</code>消息</p>
</blockquote>
</li>
<li><p>中断事务</p>
<blockquote>
<p>协调者收到所有参与者反馈的<code>Ack</code>消息之后，完成事务中断</p>
</blockquote>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zzzvvvxxxd</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">29</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">Kategorien</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">Tags</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zzzvvvxxxd</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zzzvvvxxxd.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
